<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>StudyTube</title>
    <style>
        /**
     * Styles for StudyTube UI
     * Inspired by CAB432 and ChatGPT suggestions
     */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            color: #333;
        }

        .section {
            margin-bottom: 30px;
        }

        /* ‚úÖ Áµ±‰∏ÄÊ∏ÖÂñÆÂçÄÂ°äÂ§ñËßÄ */
        .list-container {
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            padding-bottom: 25px;
            background: #fafafa;
        }

        .list-container h3 {
            margin-top: 0;
            font-size: 1rem;
            color: #555;
        }

        /* ‚úÖ Ë°®Ê†ºÊ®£Âºè */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #e6f3ff;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5faff;
        }

        .progress-bar {
            width: 200px;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            display: inline-block;
            margin: 0 10px;
        }

        .progress {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }

        button[disabled] {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <h1>üé¨ Welcome to StudyTube</h1>
    <div id="adminStatus" style="color: green; font-weight: bold;"></div>
    <button id="logoutBtn">Logout</button>

    <div class="section">
        <h2>List for All Uploads with Username</h2>
        <button onclick="listAllUploads()">Refresh List</button>
        <div class="list-container">
            <table id="allUploadsTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Filename</th>
                        <th>Upload Date</th>
                    </tr>
                </thead>
                <tbody id="allUploadsList"></tbody>
            </table>
        </div>
    </div>


    <!-- Upload ÂçÄÂüü -->
    <div class="section">
        <h2>Upload Your Own Videos</h2>
        <form id="uploadForm">
            Section: <input type="text" id="section" value="default"><br><br>
            <input type="file" id="videos" multiple><br><br>
            <button type="submit">Upload</button>
        </form>
    </div>

    <!-- Uploaded ÂçÄÂüü -->
    <div class="section">
        <h2>List of your own uploaded videos</h2>
        <button id="refreshBtn">Refresh List</button>
        <button onclick="listVideos()">Refresh List</button>
        <div class="list-container">
            <h3>Uploaded Files</h3>
            <table id="videoTable">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>File Name</th>
                    </tr>
                </thead>
                <tbody id="videoList"></tbody>
            </table>
        </div>

        <button onclick="transcodeSelected()">Start Transcoding</button>
    </div>


    <!-- Transcoding ÂçÄÂüü -->
    <div class="section">
        <h2>Transcoding Queue</h2>
        <button onclick="refreshTranscodeQueue()">Refresh Transcoding Queue</button>
        <div class="list-container">
            <h3>Queue Status</h3>
            <table id="transcodeTable">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Status</th>
                        <th>Download</th>
                    </tr>
                </thead>
                <tbody id="transcodeList"></tbody>
            </table>
        </div>

    </div>


    <script>
        const token = localStorage.getItem("authToken");

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("authToken");
            window.location.href = "/index.html";
        });

        // ÂÖàÊ™¢Êü•ÊòØÂê¶Êúâ token
        if (!token) {
            console.warn("No token found, redirecting to login...");
            window.location.href = "/login.html";
        }

        async function verifyAdmin() {
            try {
                const res = await fetch("/admin/verify", {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("authToken") }
                });

                console.log("Admin verify response status:", res.status);

                if (!res.ok) {
                    console.error("Not authorized as admin. Redirecting...");
                    alert("You are not authorized as admin!");
                    window.location.href = "/user.html"; // Ë∏¢ÂõûÊôÆÈÄöÈ†ÅÈù¢
                    return;
                }

                const data = await res.json();
                console.log("Admin verification successful:", data);
                // ‚úÖ ÈÄôË£°ÂèØ‰ª•Êõ¥Êñ∞È†ÅÈù¢ UI ÊàñÂàùÂßãÂåñ admin ÂäüËÉΩ
                document.getElementById("adminStatus").textContent = "Verified as admin";

            } catch (err) {
                console.error("Error verifying admin:", err);
                alert("Error verifying admin. Redirecting...");
                window.location.href = "/index.html";
            }
        }
        verifyAdmin();


        // ÂàóÂá∫Â∑≤‰∏äÂÇ≥ÂΩ±Áâá
        async function listVideos() {
            const section = document.getElementById("section").value;
            const res = await fetch(`/videos/list?section=${section}`, {
                headers: { "Authorization": "Bearer " + token }
            });
            const data = await res.json();

            const tbody = document.getElementById("videoList");
            tbody.innerHTML = "";
            data.files.forEach(f => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
          <td><input type="checkbox" value="${f}"></td>
          <td>${f}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        async function listAllUploads() {
            try {
                const res = await fetch("/videos/allUploads", {
                    headers: { "Authorization": "Bearer " + localStorage.getItem("authToken") }
                });

                if (!res.ok) {
                    throw new Error("HTTP error " + res.status);
                }

                const data = await res.json();
                console.log("All uploads:", data);

                const tbody = document.getElementById("allUploadsList");
                tbody.innerHTML = "";

                // Á¢∫Ë™ç data ÊòØÈô£Âàó
                if (!Array.isArray(data)) {
                    console.error("Expected array but got:", data);
                    return;
                }

                data.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td>${item.username}</td><td>${item.filename}</td>`;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                console.error("Error fetching all uploads:", err);
            }
        }



        // ‰∏äÂÇ≥ÂΩ±Áâá
        document.getElementById("uploadForm").addEventListener("submit", async e => {
            e.preventDefault();
            const section = document.getElementById("section").value;
            const files = document.getElementById("videos").files;
            const formData = new FormData();
            formData.append("section", section);
            for (let f of files) formData.append("videos", f);

            const res = await fetch("/videos/upload", {
                method: "POST",
                body: formData,
                headers: { "Authorization": "Bearer " + token }
            });
            const data = await res.json();
            alert(data.message);
            listVideos();
        });

        //         async function refreshTranscodeQueue() {
        //             console.log("refreshTranscodeQueue called");
        //             try {
        //                 const section = document.getElementById("section").value;
        //                 const res = await fetch("/videos/status", {
        //                     headers: { "Authorization": "Bearer " + token }
        //                 });
        //                 if (!res.ok) {
        //                     console.error("Failed to fetch status:", res.status);
        //                     return;
        //                 }
        //                 const data = await res.json();
        //                 console.log("Tasks object:", data.tasks);
        //                 for (const [file, task] of Object.entries(data.tasks)) {
        //                     console.log("File:", file, "Task:", task);
        //                 }
        //                 console.log("Status data:", data);

        //                 const tbody = document.getElementById("transcodeList");
        //                 tbody.innerHTML = "";

        //                 for (const [file, task] of Object.entries(data.tasks)) {
        //                     const tr = document.createElement("tr");
        //                     tr.innerHTML = `
        //     <td>${file}</td>
        //     <td><span id="status-${file}">${task.status}</span></td>
        //     <td><button id="download-${file}" ${task.status === "completed" ? "" : "disabled"}>Download</button></td>
        //   `;
        //                     tbody.appendChild(tr);


        //                     const downloadBtn = document.getElementById(`download-${file}`);
        //                     if (task.status === "completed") {
        //                         downloadBtn.onclick = async () => {
        //                             const res = await fetch(`/videos/download/${section}/${task.outputFile}`, {
        //                                 headers: { "Authorization": "Bearer " + token }
        //                             });

        //                             if (!res.ok) return alert("Download failed: " + res.status);

        //                             const blob = await res.blob();
        //                             const url = window.URL.createObjectURL(blob);
        //                             const a = document.createElement("a");
        //                             a.href = url;
        //                             a.download = task.outputFile;
        //                             document.body.appendChild(a);
        //                             a.click();
        //                             a.remove();
        //                         };

        //                         // downloadBtn.onclick = () => {
        //                         //     window.location.href = `/videos/download/${section}/${task.outputFile}`;
        //                         // };
        //                     }
        //                 }
        //             } catch (err) {
        //                 console.error("Error in refreshTranscodeQueue:", err);
        //             }
        //         }

        async function refreshTranscodeQueue() {
            console.log("refreshTranscodeQueue called");
            try {
                const section = document.getElementById("section").value;
                const res = await fetch("/videos/status", {
                    headers: { "Authorization": "Bearer " + token }
                });
                if (!res.ok) {
                    console.error("Failed to fetch status:", res.status);
                    return;
                }
                const data = await res.json();
                console.log("Tasks object:", data.tasks);
                for (const [file, task] of Object.entries(data.tasks)) {
                    console.log("File:", file, "Task:", task);
                }
                console.log("Status data:", data);

                const tbody = document.getElementById("transcodeList");
                tbody.innerHTML = "";

                for (const [file, task] of Object.entries(data.tasks)) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
    <td>${file}</td>
    <td><span id="status-${file}">${task.status}</span></td>
    <td><button id="download-${file}" ${task.status === "completed" ? "" : "disabled"}>Download</button></td>
  `;
                    tbody.appendChild(tr);


                    const downloadBtn = document.getElementById(`download-${file}`);
                    if (task.status === "completed") {
                        downloadBtn.onclick = async () => {
                            const res = await fetch(`/videos/download/${section}/${task.outputFile}`, {
                                headers: { "Authorization": "Bearer " + token }
                            });

                            if (!res.ok) return alert("Download failed: " + res.status);

                            const blob = await res.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = task.outputFile;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                        };

                    }
                }
            } catch (err) {
                console.error("Error in refreshTranscodeQueue:", err);
            }
        }

        async function transcodeSelected() {
            const section = document.getElementById("section").value;
            const checkboxes = document.querySelectorAll("#videoList input[type=checkbox]:checked");
            const files = Array.from(checkboxes).map(cb => cb.value);

            // UI: Âä†Âà∞ transcoding list
            const ul = document.getElementById("transcodeList");
            // ul.innerHTML = ""; // Ê∏ÖÁ©∫ËàäÂàóË°®

            files.forEach(f => {
                const li = document.createElement("li");
                li.innerHTML = `
          ${f} 
          <span id="status-${f}">Processing</span>
          // <div class="progress-bar"><div class="progress" id="progress-${f}"></div></div>
          <button id="download-${f}" disabled>Download</button>
        `;
                ul.appendChild(li);
            });
            // pollStatus(section); // ÈÄôË£°Ë¶ÅÂïüÂãïËº™Ë©¢

            // ÂëºÂè´ÂæåÁ´ØÈñãÂßãËΩâÊ™î
            const res = await fetch("/videos/transcode", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ section, files })
            });
            const data = await res.json();
            console.log("Transcode started:", data);
            // console.log(data);
            // alert(data.message);

            // ‚úÖ ÊØèÂÄãÊ™îÊ°à‰∏ÄÊó¶ÂÆåÊàêÔºåÁõ¥Êé•ÂïüÁî®‰∏ãËºâÊåâÈàï
            files.forEach(f => {
                const checkInterval = setInterval(async () => {
                    const statusRes = await fetch("/videos/status", {
                        headers: { "Authorization": "Bearer " + token }
                    });
                    const statusData = await statusRes.json();

                    const task = statusData.tasks[f];
                    if (!task) return;

                    const statusEl = document.getElementById(`status-${f}`);
                    const downloadBtn = document.getElementById(`download-${f}`);

                    statusEl.textContent = task.status;

                    if (task.status === "completed") {
                        downloadBtn.disabled = false;

                        downloadBtn.onclick = async () => {
                            const res = await fetch(`/videos/download/${section}/${task.outputFile}`, {
                                headers: { "Authorization": "Bearer " + token }
                            });

                            if (!res.ok) return alert("Download failed: " + res.status);

                            const blob = await res.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = task.outputFile;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                        };
                        // downloadBtn.onclick = () => {
                        //   window.location.href = `/videos/download/${section}/${task.outputFile}`;
                        // };
                        // downloadBtn.onclick = () => {
                        //   window.location.href = `/videos/download?section=${section}&file=${task.outputFile}`;
                        // };

                        clearInterval(checkInterval); // ‚úÖ ÂÆåÊàêÂæåÂ∞±ÂÅúÊéâ
                    } else if (task.status === "error") {
                        statusEl.textContent = "Error";
                        clearInterval(checkInterval);
                    }
                }, 3000); // ÊØè 3 ÁßíÊ™¢Êü•‰∏ÄÊ¨°
            });

        }
        // ÈÅ∏ÊìáÂΩ±ÁâáÈÄ≤Ë°åËΩâÊ™î
        //         async function transcodeSelected() {
        //             const section = document.getElementById("section").value;
        //             const checkboxes = document.querySelectorAll("#videoList input[type=checkbox]:checked");
        //             const files = Array.from(checkboxes).map(cb => cb.value);

        //             const tbody = document.getElementById("transcodeList");
        //             tbody.innerHTML = "";

        //             for (const [file, task] of Object.entries(data.tasks)) {
        //                 const tr = document.createElement("tr");
        //                 tr.innerHTML = `
        //     <td>${file}</td>
        //     <td><span id="status-${file}">${task.status}</span></td>
        //     <td><button id="download-${file}" ${task.status === "completed" ? "" : "disabled"}>Download</button></td>
        //   `;
        //                 tbody.appendChild(tr);
        //             }

        //             // ÂëºÂè´ÂæåÁ´ØÈñãÂßãËΩâÊ™î
        //             const res = await fetch("/videos/transcode", {
        //                 method: "POST",
        //                 headers: {
        //                     "Content-Type": "application/json",
        //                     "Authorization": "Bearer " + token
        //                 },
        //                 body: JSON.stringify({ section, files })
        //             });
        //             const data = await res.json();
        //             console.log("Transcode started:", data);

        //             // ‚úÖ ÊØèÂÄãÊ™îÊ°à‰∏ÄÊó¶ÂÆåÊàêÔºåÁõ¥Êé•ÂïüÁî®‰∏ãËºâÊåâÈàï
        //             files.forEach(f => {
        //                 const checkInterval = setInterval(async () => {
        //                     const statusRes = await fetch("/videos/status", {
        //                         headers: { "Authorization": "Bearer " + token }
        //                     });
        //                     const statusData = await statusRes.json();

        //                     const task = statusData.tasks[f];
        //                     if (!task) return;

        //                     const statusEl = document.getElementById(`status-${f}`);
        //                     const downloadBtn = document.getElementById(`download-${f}`);

        //                     statusEl.textContent = task.status;

        //                     if (task.status === "completed") {
        //                         downloadBtn.disabled = false;
        //                         downloadBtn.onclick = async () => {
        //                             const res = await fetch(`/videos/download/${section}/${task.outputFile}`, {
        //                                 headers: { "Authorization": "Bearer " + token }
        //                             });

        //                             if (!res.ok) return alert("Download failed: " + res.status);

        //                             const blob = await res.blob();
        //                             const url = window.URL.createObjectURL(blob);
        //                             const a = document.createElement("a");
        //                             a.href = url;
        //                             a.download = task.outputFile;
        //                             document.body.appendChild(a);
        //                             a.click();
        //                             a.remove();
        //                         };


        //                         clearInterval(checkInterval); // ‚úÖ ÂÆåÊàêÂæåÂ∞±ÂÅúÊéâ
        //                     } else if (task.status === "error") {
        //                         statusEl.textContent = "Error";
        //                         clearInterval(checkInterval);
        //                     }
        //                 }, 3000); // ÊØè 3 ÁßíÊ™¢Êü•‰∏ÄÊ¨°
        //             });

        //         }


    </script>
</body>

</html>